<html>
<head>

    <title>Peanuts</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/deps/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="/deps/highlightjs/styles/darkula.css">
    <link rel="stylesheet" href="/assets/styles/styles.css">
    
    <script src="/assets/scripts/codePrinter.js"></script>

    <script src="/deps/highlightjs/highlight.pack.min.js"></script>
    <script src="/deps/dat.gui/build/dat.gui.min.js"></script>
    <script src="/deps/stats-js/build/stats.min.js"></script>
    <script src="/deps/signals/dist/signals.min.js"></script>

    <script src="/deps/three/build/three.min.js"></script>
    <script src="/deps/three/examples/js/controls/OrbitControls.js"></script>
    <script src="/deps/three/examples/js/effects/AsciiEffect.js"></script>

    <script src="/app/peanuts.js"></script>
    <script src="/app/peanuts.three.driver.js"></script>
    <script src="/app/peanuts.three.inputs.js"></script>
    <script src="/app/peanuts.three.loaders.js"></script>
    <script src="/app/peanuts.three.app.js"></script>
    <script src="/app/peanuts.three.app.builder.js"></script>
    <script src="/app/peanuts.three.app.factory.js"></script>
    <script src="/app/peanuts.three.view.js"></script>
    <script src="/app/peanuts.three.view.builder.js"></script>
    <script src="/app/ui/peanuts.three.dat.gui.geometry.js"></script>

    <style type="text/css">
        .threeApp {
            height: 100%;
            width: 100%;
        }
    </style>

</head>

<body class="page">

    <div id="app" class="threeApp" width="1920" height="1080" style="height:1080px; width:1920px;"></div>

    <script type="text/javascript">

        var ImprovedNoise = function () {

    var p = [151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,
         23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,
         174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,
         133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,
         89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,
         202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,
         248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,
         178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,
         14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,
         93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];

    for (var i=0; i < 256 ; i++) {

        p[256+i] = p[i];

    }

    function fade(t) {

        return t * t * t * (t * (t * 6 - 15) + 10);

    }

    function lerp(t, a, b) {

        return a + t * (b - a);

    }

    function grad(hash, x, y, z) {

        var h = hash & 15;
        var u = h < 8 ? x : y, v = h < 4 ? y : h == 12 || h == 14 ? x : z;
        return ((h&1) == 0 ? u : -u) + ((h&2) == 0 ? v : -v);

    }

    return {

        noise: function (x, y, z) {

            var floorX = Math.floor(x), floorY = Math.floor(y), floorZ = Math.floor(z);

            var X = floorX & 255, Y = floorY & 255, Z = floorZ & 255;

            x -= floorX;
            y -= floorY;
            z -= floorZ;

            var xMinus1 = x -1, yMinus1 = y - 1, zMinus1 = z - 1;

            var u = fade(x), v = fade(y), w = fade(z);

            var A = p[X]+Y, AA = p[A]+Z, AB = p[A+1]+Z, B = p[X+1]+Y, BA = p[B]+Z, BB = p[B+1]+Z;

            return lerp(w, lerp(v, lerp(u, grad(p[AA], x, y, z), 
                            grad(p[BA], xMinus1, y, z)),
                        lerp(u, grad(p[AB], x, yMinus1, z),
                            grad(p[BB], xMinus1, yMinus1, z))),
                    lerp(v, lerp(u, grad(p[AA+1], x, y, zMinus1),
                            grad(p[BA+1], xMinus1, y, z-1)),
                        lerp(u, grad(p[AB+1], x, yMinus1, zMinus1),
                            grad(p[BB+1], xMinus1, yMinus1, zMinus1))));

        }
    }
}

        var demoSettings = {
            texOffX: 0.0375952582557155,
            texOffY: 0.0375952582557155,
            floorWidth: 50,
            floorDepth: 50,
            floorHeight: 2,
            floorRes: 128,
            stepCount: 0,
            noiseSeed: Math.random() * 100,
            noiseScale: 9,
            moveSpeed: 0.05
        };

        (CodePrinter.printAndRun(function(initUI) {

            var app = new Peanuts.Three.App.Factory(
                document.getElementById("app")
            ).createDemoGLPerspectiveApp();

            app.renderer.setClearColor(0,0);

            var assets = {
                fonts : {},
                lights: {},
                textures: {},
                geometries : {}
            };

            function loadAssets() {

                function setAsset(key, subKey) {
                    return function(asset) {
                        assets[key][subKey] = asset;
                    }
                }

                return Promise.all([
                    app.loader.promising.load(app.loader.font, '/assets/fonts/FontAwesome.json').then(setAsset('fonts','awesome')),
                    app.loader.promising.load(app.loader.font, '/assets/fonts/Arial.json').then(setAsset('fonts','arial')),
                    app.loader.promising.load(app.loader.texture, 'textures/metal/mtl_wall01_c.png').then(setAsset('textures','spotXtex')),
                    app.loader.promising.load(app.loader.texture, 'textures/metal/mtl_wall01_n.png').then(setAsset('textures','spotXnormal')),
                    app.loader.promising.load(app.loader.texture, 'textures/metal/mtl_wall01_s.png').then(setAsset('textures','spotXspecular')),
                    app.loader.promising.load(app.loader.texture, 'textures/earth/earthmap1k.jpg').then(setAsset('textures','earthTex')),
                    app.loader.promising.load(app.loader.texture, 'textures/earth/earthbump1k.jpg').then(setAsset('textures','earthNormal')),
                    app.loader.promising.load(app.loader.texture, 'textures/earth/earthspec1k.jpg').then(setAsset('textures','earthSpecular')),
                    app.loader.promising.load(app.loader.texture, 'textures/metal/metal-grill.jpg').then(setAsset('textures','metalGrillTex')),
                ]);
            } 

            function createFloor() { 


                var floorGeometry = new THREE.PlaneGeometry(
                        demoSettings.floorWidth, 
                        demoSettings.floorDepth, 
                        demoSettings.floorRes, 
                        demoSettings.floorRes
                );


                var floorMaterial1 = new THREE.MeshPhongMaterial({
                        color: 0xeeeeee, 
                        side: THREE.DoubleSide, 
                        blending: THREE.AdditiveBlending, 
                        wireframe: true
                });

                var floorMaterial2 = new THREE.MeshPhongMaterial({
                    color: 'white',
                    side: THREE.DoubleSide, 
                    map: assets.textures.metalGrillTex,
                    alphaMap: assets.textures.metalGrillTex,
                    normalMap: assets.textures.metalGrillTex,
                    specularMap: assets.textures.metalGrillTex,
                    metalness: 1.0,
                    shininess: 1.0,
                    specular: 'white',
                    wireframe: false
                });

                floorMaterial2.map.wrapS = THREE.RepeatWrapping;
                floorMaterial2.map.wrapT = THREE.RepeatWrapping;
                floorMaterial2.map.offset.set(0,0);
                floorMaterial2.map.repeat.set(10,10);

                var floorMesh1 = new THREE.Mesh(floorGeometry, floorMaterial1);
                    floorMesh1.rotation.x = Math.PI / 1.65;
                    floorMesh1.rotation.x = Math.PI / 2;

                var floorMesh2 = new THREE.Mesh(floorGeometry, floorMaterial2);
                    floorMesh2.rotation.x = Math.PI / 1.65;
                    floorMesh2.rotation.x = Math.PI / 2;

                var floorGroup = new THREE.Object3D();

                //floorGroup.add(floorMesh1);
                floorGroup.add(floorMesh2);
                floorGroup.position.y = 0;

                assets.geometries.floor = floorGeometry;

                return floorGroup;
            }

            function animateFloor(floorGeometry) {

                var snoise = new ImprovedNoise();

                var ds = demoSettings;

                ds.stepCount++;

                var offset = ds.stepCount * ds.moveSpeed / ds.floorDepth * ds.floorRes;

                for (var i = 0; i < ds.floorRes + 1; i++) {
                    for (var j = 0; j <  ds.floorRes + 1; j++) {

                        var ipos = i + offset;

                        floorGeometry.vertices[i * (ds.floorRes + 1) + j].z = snoise.noise(
                            ipos / ds.floorRes * ds.noiseScale, 
                            j / ds.floorRes * ds.noiseScale, 
                            ds.noiseSeed
                        );

                        if ((i > 30) || (j < 12) || (j > 48)) {
                          floorGeometry.vertices[i * (ds.floorRes + 1) + j].z *= ds.floorHeight;
                        } else if (i > 25 && i < 30) {
                          floorGeometry.vertices[i * (ds.floorRes + 1) + j].z *= (ds.floorHeight / 1.2);
                        } else {
                          floorGeometry.vertices[i * (ds.floorRes + 1) + j].z *= (ds.floorHeight / 2);
                        }
                    }
                }

                floorGeometry.verticesNeedUpdate = true;
            }


            function createSpotXText() {

                 var spotMesh = new THREE.Mesh(
                    new THREE.TextGeometry("SPOT", {
                        font: assets.fonts.arial,
                        size: 1,
                        height: 0.2,
                        curveSegments: 5
                    }), 
                    new THREE.MeshPhongMaterial({
                        color: 'black',
                        shininess: demoSettings.shny,
                        metalness: 1.0,
                        specular: 'white',
                        wireframe: false
                    })
                );

                spotMesh.geometry.center();

                var xMesh = new THREE.Mesh(
                    new THREE.TextGeometry("X", {
                        font: assets.fonts.arial,
                        size: 1,
                        height: 0.2,
                        curveSegments: 5
                    }), 
                    new THREE.MeshPhongMaterial({
                        color: 'green',
                        map: assets.textures.spotXtex,
                        normalMap: assets.textures.spotXnormal,
                        specularMap: assets.textures.spotXspecular,
                        specular: 'white',
                        wireframe: false
                    })
                );

                xMesh.geometry.center();

                var spotMeshWidth = (new THREE.Box3().setFromObject(spotMesh)).getSize().x;
                var xMeshWidth = (new THREE.Box3().setFromObject(xMesh)).getSize().x;
    
                spotMesh.translateX(((xMeshWidth/2)*-1));
                xMesh.translateX((spotMeshWidth/2)+0.1);

                var spotXGroup = new THREE.Group();

                spotXGroup.add(spotMesh);
                spotXGroup.add(xMesh);
                
                spotXGroup.translateY(1);

                return spotXGroup;
            }


            function createLights() {

                var hemisphereLight = new THREE.HemisphereLight(0x0000ff, 0x000000, 0.7);
            
                var centerLight = new THREE.SpotLight(0xb7f9ff, 1);
                    centerLight.position.set(0,90,0);
                    centerLight.penumbra = 1;
                    centerLight.decay = 5;

                var directionalLight = new THREE.PointLight(0xFFFFFF);
                    directionalLight.translateZ(3);
   
                var ambientLight =new THREE.AmbientLight(0x222222);

                var pointLight1 = new THREE.PointLight(0xFF0000);
                    pointLight1.position.z = 0;
                    pointLight1.position.y = 0;
                    pointLight1.position.x = 20;

                var pointLight2 = new THREE.PointLight(0x00FF00);
                    pointLight1.position.z = 0;
                    pointLight1.position.y = 0;
                    pointLight1.position.x = -20;


                lightBranch = new THREE.Group();
                lightBranch.add(ambientLight);
                lightBranch.add(hemisphereLight);
                lightBranch.add(directionalLight);
                lightBranch.add(centerLight);

                movingLightBranch = new THREE.Group();
                movingLightBranch.add(pointLight1);
                movingLightBranch.add(pointLight2);

                lightBranch.add(movingLightBranch);

                assets.lights.moving = movingLightBranch;

                return lightBranch;
            }

            function animateLights(lights) {

                lights.rotateY(0.01);

            }


            function loadScene(ds) {

                app.view.setScene(new THREE.Scene());
                //app.view.scene.fog = new THREE.FogExp2(0x1c3c4a, 0.01);

                app.view.scene.add(createLights());
                app.view.scene.add(createFloor());
                app.view.scene.add(createSpotXText());
            }

            app.inputs.mouse.events.onMouseDown.add(function(mouseState) {});

            app.inputs.mouse.events.onMouseUp.add(function(mouseState) {});

            app.onUpdate(function() {
                animateFloor(assets.geometries.floor);
                animateLights( assets.lights.moving);
            });

            loadAssets().then(function() {
                loadScene(demoSettings);
                app.start();
            });
        

            initUI(app, loadScene); //Ignore me, demo menu initalisation

        }, function(app, loadScene) {

            var uiControllers = [];
    
    
            uiControllers.push(app.datGui.add(demoSettings, 'noiseSeed', 0, 10));
            uiControllers.push(app.datGui.add(demoSettings, 'noiseScale', 0, 10));
            uiControllers.push(app.datGui.add(demoSettings, 'moveSpeed', 0, 1));
            // uiControllers.push(app.datGui.add(demoSettings, 'texOffX', 0, 1));
            // uiControllers.push(app.datGui.add(demoSettings, 'texOff', 0, 1));
            
            uiControllers.forEach(function(item) {
                item.onChange( function(value) {
                    loadScene(demoSettings) 
                });
            });

        }))();

    </script>


</body>

</html>