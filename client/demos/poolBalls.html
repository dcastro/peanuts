<html>
<head>

    <title>Peanuts</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/deps/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="/deps/highlightjs/styles/darkula.css">
    <link rel="stylesheet" href="/assets/styles/styles.css">
    
    <script src="/assets/scripts/codePrinter.js"></script>

    <script src="/deps/highlightjs/highlight.pack.min.js"></script>
    <script src="/deps/dat.gui/build/dat.gui.min.js"></script>
    <script src="/deps/stats-js/build/stats.min.js"></script>
    <script src="/deps/signals/dist/signals.min.js"></script>

    <script src="/deps/three/build/three.min.js"></script>
    <script src="/deps/three/examples/js/controls/OrbitControls.js"></script>
    <script src="/deps/three/examples/js/effects/AsciiEffect.js"></script>

    <script src="/app/peanuts.js"></script>
    <script src="/app/peanuts.three.driver.js"></script>
    <script src="/app/peanuts.three.inputs.js"></script>
    <script src="/app/peanuts.three.loaders.js"></script>
    <script src="/app/peanuts.three.app.js"></script>
    <script src="/app/peanuts.three.app.builder.js"></script>
    <script src="/app/peanuts.three.app.factory.js"></script>
    <script src="/app/peanuts.three.assets.js"></script>
    <script src="/app/peanuts.three.view.js"></script>
    <script src="/app/peanuts.three.view.builder.js"></script>
    <script src="/app/peanuts.three.math.helpers.js"></script>
    <script src="/app/ui/peanuts.three.dat.gui.geometry.js"></script>

    <style type="text/css">
        .threeApp {
            height: 100%;
            width: 100%;
        }
    </style>

</head>

<body class="page">

    <div id="app" class="threeApp" width="1920" height="1080" style="height:1080px; width:1920px;"></div>

    <script type="text/javascript">

        var demoObjects = {};

        var demoSettings = {};

        (CodePrinter.printAndRun(function(initUI) {

            var app = new Peanuts.Three.App.Factory(
                document.getElementById("app")
            ).createDemoGLPerspectiveApp();

            app.renderer.setClearColor(0,0);

            app.renderer.gammaInput = true;
            app.renderer.gammaOutput = true;

            app.inputs.mouse.events.onMouseDown.add(function(mouseState) {});
            app.inputs.mouse.events.onMouseUp.add(function(mouseState) {});

            app.onUpdate(function() {
                demoObjects.ball.animate(demoSettings);
            });

            function loadScene() {

                Promise.all([

                    app.assets.loadTexture('textures/balls/shinyEnvMap.png', 'envMap')

                ]).then(function() {

                    demoObjects.lighs = new Lights(app.assets,demoSettings);
                    demoObjects.ball = new PoolBall(app.assets,demoSettings);

                    app.view.setScene(new THREE.Scene());
                    app.view.scene.add(demoObjects.ball.object3D);

                    app.start();
                });
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            function PoolBall(assets,demoSettings) {

                this.mesh = new THREE.Mesh(
                    new THREE.SphereGeometry(
                        1,
                        64,
                        64,
                        0,
                        6.3,
                        0,
                        6.3
                    ), 
                    new THREE.MeshStandardMaterial({
                        color: 'red',
                        roughness: 0, 
                        envMap: assets.getTexture('envMap')
                    })
                );

                this.mesh.material.envMap.mapping = THREE.SphericalReflectionMapping;

                this.mesh.geometry.center();

                this.object3D = new THREE.Group();
                this.object3D.add(this.mesh);

                console.log('here', this);

                return this;
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            PoolBall.prototype.animate = function() {}

            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            function Lights(assets,demoObjects) {

                this.hemisphereLight = new THREE.HemisphereLight(0x0000ff, 0x000000, 0.7);
            
                this.centerLight = new THREE.SpotLight(0xb7f9ff, 1);
                this.centerLight.position.set(0,90,0);
                this.centerLight.penumbra = 1;
                this.centerLight.decay = 5;

                this.directionalLight = new THREE.PointLight(0xFFFFFF);
                this.directionalLight.translateZ(3);
   
                this.ambientLight = new THREE.AmbientLight(0x222222);

                this.pointLight1 = new THREE.PointLight(0xFF0000);
                this.pointLight1.position.z = 0;
                this.pointLight1.position.y = 0;
                this.pointLight1.position.x = 20;

                this.pointLight2 = new THREE.PointLight(0x00FF00);
                this.pointLight2.position.z = 0;
                this.pointLight2.position.y = 0;
                this.pointLight2.position.x = -20;

                this.movingLights = new THREE.Group();
                this.movingLights.add(this.pointLight1);
                this.movingLights.add(this.pointLight2);

                this.object3D = new THREE.Group();
                this.object3D.add(this.ambientLight);
                this.object3D.add(this.hemisphereLight);
                this.object3D.add(this.directionalLight);
                this.object3D.add(this.centerLight);
                this.object3D.add(this.movingLights);

                return this;
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            Lights.prototype.animate = function(demoSettings) {
                this.movingLights.rotateY(0.01);
            }
            
            loadScene();

            initUI(app, loadScene); //Ignore me, demo menu initalisation

        }, function(app, loadScene) {

            var uiControllers = [];
    
            uiControllers.forEach(function(item) {
                item.onChange( function(value) {
                    loadScene(demoSettings) 
                });
            });

        }))();

    </script>
</body>
</html>