<html>
<head>

    <title>Peanuts</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/deps/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="/deps/highlightjs/styles/darkula.css">
    <link rel="stylesheet" href="/assets/styles/styles.css">
    
    <script src="/assets/scripts/codePrinter.js"></script>

    <script src="/deps/highlightjs/highlight.pack.min.js"></script>
    <script src="/deps/dat.gui/build/dat.gui.min.js"></script>
    <script src="/deps/stats-js/build/stats.min.js"></script>
    <script src="/deps/signals/dist/signals.min.js"></script>

    <script src="/deps/three/build/three.min.js"></script>
    <script src="/deps/three/examples/js/controls/OrbitControls.js"></script>
    <script src="/deps/three/examples/js/effects/AsciiEffect.js"></script>

    <script src="/app/peanuts.js"></script>
    <script src="/app/peanuts.three.driver.js"></script>
    <script src="/app/peanuts.three.inputs.js"></script>
    <script src="/app/peanuts.three.loaders.js"></script>
    <script src="/app/peanuts.three.assets.js"></script>
    <script src="/app/peanuts.three.app.js"></script>
    <script src="/app/peanuts.three.app.builder.js"></script>
    <script src="/app/peanuts.three.app.factory.js"></script>
    <script src="/app/peanuts.three.view.js"></script>
    <script src="/app/peanuts.three.view.builder.js"></script>
    <script src="/app/peanuts.three.math.helpers.js"></script>
    <script src="/app/ui/peanuts.three.dat.gui.geometry.js"></script>

    <style type="text/css">
        .threeApp {
            height: 100%;
            width: 100%;
        }
    </style>

</head>

<body class="page">

    <div id="app" class="threeApp" width="1920" height="1080" style="height:1080px; width:1920px;"></div>

    <script type="text/javascript">

        var demoObjects = {};

        var demoSettings = {
            texOffX: 0.0375952582557155,
            texOffY: 0.0375952582557155,
            floorWidth: 50,
            floorDepth: 50,
            floorHeight: 2,
            floorRes: 128,
            stepCount: 0,
            noiseSeed: Math.random() * 100,
            noiseScale: 9,
            moveSpeed: 0.05
        };

        (CodePrinter.printAndRun(function(initUI) {

            var app = new Peanuts.Three.App.Factory(
                document.getElementById("app")
            ).createDemoGLPerspectiveApp();

            app.renderer.setClearColor(0,0);

            app.inputs.mouse.events.onMouseDown.add(function(mouseState) {});
            app.inputs.mouse.events.onMouseUp.add(function(mouseState) {});

            app.onUpdate(function() {
                demoObjects.lights.animate(demoSettings);
                demoObjects.waves.animate(demoSettings);
                demoObjects.logo.animate(demoSettings);
            });

            function loadScene() {

                Promise.all([
                    app.assets.loadFont('/assets/fonts/Arial.json','arial'),
                    app.assets.loadFont('/assets/fonts/FontAwesome.json','awesome'),
                    app.assets.loadTexture('textures/metal/mtl_wall01_c.png', 'spotXtex'),
                    app.assets.loadTexture('textures/metal/mtl_wall01_n.png', 'spotXnormal'),
                    app.assets.loadTexture('textures/metal/mtl_wall01_s.png', 'spotXspecular'),
                    app.assets.loadTexture('textures/earth/earthmap1k.jpg', 'earthTex'),
                    app.assets.loadTexture('textures/earth/earthbump1k.jpg', 'earthNormal'),
                    app.assets.loadTexture('textures/earth/earthspec1k.jpg', 'earthSpecular'),
                    app.assets.loadTexture('textures/metal/metal-grill.jpg', 'metalGrillTex'),
                ]).then(function() {

                    demoObjects.lights = new Lights(app.assets,demoSettings);
                    demoObjects.waves = new Waves(app.assets,demoSettings);
                    demoObjects.logo = new Logo(app.assets,demoSettings);

                    app.view.setScene(new THREE.Scene());
                    app.view.scene.add(demoObjects.lights.object3D);
                    app.view.scene.add(demoObjects.waves.object3D);
                    app.view.scene.add(demoObjects.logo.object3D);

                    app.start();
                });
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            function Waves(assets,demoSettings) {

                this.geometry = new THREE.PlaneGeometry(
                        demoSettings.floorWidth, 
                        demoSettings.floorDepth, 
                        demoSettings.floorRes, 
                        demoSettings.floorRes
                );

                this.material1 = new THREE.MeshPhongMaterial({
                        color: 0xeeeeee, 
                        side: THREE.DoubleSide, 
                        blending: THREE.AdditiveBlending, 
                        wireframe: true
                });

                this.material2 = new THREE.MeshPhongMaterial({
                    color: 'white',
                    side: THREE.DoubleSide, 
                    map: assets.getTexture('metalGrillTex'),
                    alphaMap: assets.getTexture('metalGrillTex'),
                    normalMap: assets.getTexture('metalGrillTex'),
                    specularMap: assets.getTexture('metalGrillTex'),
                    metalness: 1.0,
                    shininess: 1.0,
                    specular: 'white',
                    wireframe: false
                });

                this.material2.map.wrapS = THREE.RepeatWrapping;
                this.material2.map.wrapT = THREE.RepeatWrapping;
                this.material2.map.offset.set(0,0);
                this.material2.map.repeat.set(10,10);

                this.mesh1 = new THREE.Mesh(this.geometry, this.material1);
                this.mesh1.rotation.x = Math.PI / 1.65;
                this.mesh1.rotation.x = Math.PI / 2;

                this.mesh2 = new THREE.Mesh(this.geometry, this.material2);
                this.mesh2.rotation.x = Math.PI / 1.65;
                this.mesh2.rotation.x = Math.PI / 2;

                this.object3D = new THREE.Object3D();

                this.object3D.add(this.mesh1);
                this.object3D.add(this.mesh2);
                this.object3D.position.y = 0;

                return this;
            }

            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            Waves.prototype.animate = function(demoSettings) {

                var snoise = Peanuts.Three.Math.Helpers.Noise;

                var ds = demoSettings;

                ds.stepCount++;

                var offset = ds.stepCount * ds.moveSpeed / ds.floorDepth * ds.floorRes;

                for (var i = 0; i < ds.floorRes + 1; i++) {
                    for (var j = 0; j <  ds.floorRes + 1; j++) {

                        var ipos = i + offset;

                        this.geometry.vertices[i * (ds.floorRes + 1) + j].z = snoise.noise(
                            ipos / ds.floorRes * ds.noiseScale, 
                            j / ds.floorRes * ds.noiseScale, 
                            ds.noiseSeed
                        );

                        if ((i > 30) || (j < 12) || (j > 48)) {
                          this.geometry.vertices[i * (ds.floorRes + 1) + j].z *= ds.floorHeight;
                        } else if (i > 25 && i < 30) {
                          this.geometry.vertices[i * (ds.floorRes + 1) + j].z *= (ds.floorHeight / 1.2);
                        } else {
                          this.geometry.vertices[i * (ds.floorRes + 1) + j].z *= (ds.floorHeight / 2);
                        }
                    }
                }

                this.geometry.verticesNeedUpdate = true;
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            function Logo(assets,demoSettings) {

                this.spotMesh = new THREE.Mesh(
                    new THREE.TextGeometry("SPOT", {
                        font: assets.getFont('arial'),
                        size: 1,
                        height: 0.2,
                        curveSegments: 5
                    }), 
                    new THREE.MeshPhongMaterial({
                        color: 'black',
                        shininess: demoSettings.shny,
                        metalness: 1.0,
                        specular: 'white',
                        wireframe: false
                    })
                );

                this.spotMesh.geometry.center();

                this.xMesh = new THREE.Mesh(
                    new THREE.TextGeometry("X", {
                        font: assets.getFont('arial'),
                        size: 1,
                        height: 0.2,
                        curveSegments: 5
                    }), 
                    new THREE.MeshPhongMaterial({
                        color: 'green',
                        map: assets.getTexture('spotXtex'),
                        normalMap: assets.getTexture('spotXnormal'),
                        specularMap: assets.getTexture('spotXspecular'),
                        specular: 'white',
                        wireframe: false
                    })
                );

                this.xMesh.geometry.center();

                var spotMeshWidth = (new THREE.Box3().setFromObject(this.spotMesh)).getSize().x;
                var xMeshWidth = (new THREE.Box3().setFromObject(this.xMesh)).getSize().x;

                console.log('widths', spotMeshWidth, xMeshWidth);
    
                this.spotMesh.translateX(((xMeshWidth/2)*-1));
                this.xMesh.translateX((spotMeshWidth/2)+0.1);

                this.object3D = new THREE.Group();
                this.object3D.add(this.spotMesh);
                this.object3D.add(this.xMesh);
                this.object3D.translateY(1);

                return this;
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            Logo.prototype.animate = function() {}

            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            function Lights(assets,demoObjects) {

                this.hemisphereLight = new THREE.HemisphereLight(0x0000ff, 0x000000, 0.7);
            
                this.centerLight = new THREE.SpotLight(0xb7f9ff, 1);
                this.centerLight.position.set(0,90,0);
                this.centerLight.penumbra = 1;
                this.centerLight.decay = 5;

                this.directionalLight = new THREE.PointLight(0xFFFFFF);
                this.directionalLight.translateZ(3);
   
                this.ambientLight = new THREE.AmbientLight(0x222222);

                this.pointLight1 = new THREE.PointLight(0xFF0000);
                this.pointLight1.position.z = 0;
                this.pointLight1.position.y = 0;
                this.pointLight1.position.x = 20;

                this.pointLight2 = new THREE.PointLight(0x00FF00);
                this.pointLight2.position.z = 0;
                this.pointLight2.position.y = 0;
                this.pointLight2.position.x = -20;

                this.movingLights = new THREE.Group();
                this.movingLights.add(this.pointLight1);
                this.movingLights.add(this.pointLight2);

                this.object3D = new THREE.Group();
                this.object3D.add(this.ambientLight);
                this.object3D.add(this.hemisphereLight);
                this.object3D.add(this.directionalLight);
                this.object3D.add(this.centerLight);
                this.object3D.add(this.movingLights);

                return this;
            }


            /////////////////////////////////////////////////////////////////////////////////
            //
            //
            /////////////////////////////////////////////////////////////////////////////////
            Lights.prototype.animate = function(demoSettings) {
                this.movingLights.rotateY(0.01);
            }
            
            loadScene();

            initUI(app, loadScene); //Ignore me, demo menu initalisation

        }, function(app, loadScene) {

            var uiControllers = [];
    
            uiControllers.push(app.datGui.add(demoSettings, 'noiseSeed', 0, 10));
            uiControllers.push(app.datGui.add(demoSettings, 'noiseScale', 0, 10));
            uiControllers.push(app.datGui.add(demoSettings, 'moveSpeed', 0, 1));
            
            uiControllers.forEach(function(item) {
                item.onChange( function(value) {
                    loadScene(demoSettings) 
                });
            });

        }))();

    </script>


</body>

</html>